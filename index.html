<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculateur de Pointage Module</title>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";

        // REMPLACEZ LES VALEURS CI-DESSOUS PAR CELLES DE VOTRE CONSOLE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCRfoq0nvgVKRDTrF8jR4sGR7O3tpz6LJI",
            authDomain: "tournoi-robotique.firebaseapp.com",
            projectId: "tournoi-robotique",
            storageBucket: "tournoi-robotique.firebasestorage.app",
            messagingSenderId: "823293191367",
            appId: "1:823293191367:web:667f3a455fcd9f5dcc0ae2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.db = db;
        window.auth = auth;

        // Connexion automatique
        signInAnonymously(auth).then(() => {
            console.log("Connecté au Cloud");
            document.getElementById('sync-indicator').style.background = '#10b981';
        }).catch(err => {
            console.error("Erreur de connexion", err);
            document.getElementById('sync-indicator').style.background = '#ef4444';
        });
    </script>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --subtotal-color: #6366f1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: #1e293b;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        h1, h2, h3 {
            margin: 0;
            color: var(--primary);
        }

        /* La bannière est masquée visuellement mais conservée pour la structure si nécessaire */
        .inventory-banner {
            display: none;
        }

        .btn-reset-top {
            background: #f1f5f9;
            color: var(--secondary);
            border: 1px solid #e2e8f0;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-reset-top:hover {
            background: #fee2e2;
            color: var(--danger);
            border-color: #fecaca;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .field {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--secondary);
        }

        input[type="number"], input[type="text"] {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            -webkit-appearance: none;
        }

        .section-title-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f1f5f9;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .section-title {
            font-weight: bold;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0;
        }

        .subtotal-badge {
            background: var(--subtotal-color);
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .counter-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .counter-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #e2e8f0;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .btn-circle:active { background: #cbd5e1; }
        .btn-circle:disabled { opacity: 0.2; cursor: not-allowed; background: #f1f5f9; }

        .checkbox-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #e2e8f0;
        }

        .checkbox-label-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bonus-value-badge {
            font-weight: 800;
            font-size: 0.9rem;
            color: #b91c1c;
        }

        .score-display {
            background: var(--primary);
            color: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .score-number {
            font-size: 3.5rem;
            font-weight: 800;
            display: block;
        }

        .bonus-info {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 5px;
            display: block;
            line-height: 1.4;
        }

        .btn-save {
            background: var(--success);
            color: white;
            border: none;
            width: 100%;
            padding: 18px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #059669;
        }

        .btn-save:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #059669;
        }

        /* Styles Resultats */
        .team-group {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            background: white;
        }

        .team-header {
            background: #ffffff;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .team-header:hover { background: #f8fafc; }

        .team-id-container {
            display: flex;
            align-items: center;
        }

        .team-id {
            background: #dbeafe;
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 800;
            font-size: 1.1rem;
        }

        .team-summary {
            text-align: right;
        }

        .score-total-val {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--success);
            display: block;
        }

        .score-avg-val {
            font-size: 0.75rem;
            color: var(--secondary);
            font-weight: 600;
        }

        .team-details {
            display: none;
            background: #f8fafc;
            padding: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .team-details.open { display: block; }

        .match-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 5px;
        }

        .breakdown-table {
            width: 100%;
            font-size: 0.8rem;
            border-collapse: collapse;
        }

        .breakdown-table td {
            padding: 4px 0;
            color: var(--secondary);
        }

        .breakdown-table td:last-child {
            text-align: right;
            font-weight: bold;
            color: #1e293b;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .view { display: none; }
        .view.active { display: block; }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--secondary);
            font-style: italic;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <div class="tab active" onclick="switchTab('scout')">Saisie Match</div>
        <div class="tab" onclick="switchTab('results')">Résultats Tournoi</div>
    </div>

    <!-- VUE SAISIE -->
    <div id="scoutView" class="view active">
        <div class="card">
            <div class="header-actions">
                <h1>Pointage</h1>
                <button class="btn-reset-top" onclick="resetFormWithConfirm()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M3 21v-5h5"></path></svg>
                    Nouveau Match
                </button>
            </div>

            <!-- Masqué visuellement mais gardé pour les IDs JS -->
            <div class="inventory-banner">
                <span id="global-piece-count">0 / 21</span>
            </div>
            
            <div class="input-group">
                <div class="field">
                    <label>Numéro de l'équipe</label>
                    <input type="number" id="teamNumber" placeholder="Ex: 5440" oninput="calculateScore()">
                </div>
            </div>

            <div class="section-title-container">
                <p class="section-title">Moteurs (Max 3/moteur)</p>
                <span class="subtotal-badge" id="subtotal-moteurs">0 pt</span>
            </div>
            <div id="moteursList">
                <script>
                    for(let i=1; i<=6; i++) {
                        document.write(`
                            <div class="counter-row">
                                <span>Moteur ${i}</span>
                                <div class="counter-controls">
                                    <button class="btn-circle" id="moteur${i}-minus" onclick="updateVal('moteur${i}', -1)">-</button>
                                    <span id="moteur${i}-val" style="width:25px; text-align:center; font-weight:bold;">0</span>
                                    <button class="btn-circle" id="moteur${i}-plus" onclick="updateVal('moteur${i}', 1)">+</button>
                                </div>
                            </div>
                        `);
                    }
                </script>
            </div>

            <div class="section-title-container">
                <p class="section-title">Stations de Réparation (30 pts / pièce)</p>
                <span class="subtotal-badge" id="subtotal-stations">0 pt</span>
            </div>
            <div id="stationsList">
                <script>
                    for(let i=1; i<=3; i++) {
                        document.write(`
                            <div class="counter-row">
                                <span>Station ${i}</span>
                                <div class="counter-controls">
                                    <button class="btn-circle" id="station${i}-minus" onclick="updateVal('station${i}', -1)">-</button>
                                    <span id="station${i}-val" style="width:25px; text-align:center; font-weight:bold;">0</span>
                                    <button class="btn-circle" id="station${i}-plus" onclick="updateVal('station${i}', 1)">+</button>
                                </div>
                            </div>
                        `);
                    }
                </script>
            </div>

            <div class="section-title-container">
                <p class="section-title">Pièces Supplémentaires (40 pts)</p>
                <span class="subtotal-badge" id="subtotal-supp">0 pt</span>
            </div>
            <div class="counter-row">
                <span>Nombre de pièces</span>
                <div class="counter-controls">
                    <button class="btn-circle" id="supp-minus" onclick="updateVal('supp', -1)">-</button>
                    <span id="supp-val" style="width:25px; text-align:center; font-weight:bold;">0</span>
                    <button class="btn-circle" id="supp-plus" onclick="updateVal('supp', 1)">+</button>
                </div>
            </div>

            <div class="section-title-container" style="background: #fff7ed;">
                <p class="section-title" style="color: #9a3412;">Bonus (Calculés sur pièces supp.)</p>
                <span class="subtotal-badge" id="subtotal-bonus-global" style="background: #f97316;">+0 pt</span>
            </div>
            
            <div class="checkbox-row" style="border-left: 4px solid #ef4444;">
                <div class="checkbox-label-group">
                    <input type="checkbox" id="bonusHauteur" onchange="calculateScore()">
                    <label for="bonusHauteur" style="margin:0; font-weight:600;">Bonus hauteur (x0.6)</label>
                </div>
                <span class="bonus-value-badge" id="val-bonus-hauteur">+0 pt</span>
            </div>

            <div class="checkbox-row" style="border-left: 4px solid #10b981; background: #f0fdf4;">
                <div class="checkbox-label-group">
                    <input type="checkbox" id="bonusNombre" onchange="calculateScore()">
                    <label for="bonusNombre" style="margin:0; font-weight:600;">Bonus nombre (x0.4)</label>
                </div>
                <span class="bonus-value-badge" id="val-bonus-nombre" style="color: #059669;">+0 pt</span>
            </div>

            <div class="score-display">
                <span class="bonus-info" id="bonusSummary">Pièces: 0 | Hauteur: +0 | Nombre: +0</span>
                <small>POINTAGE TOTAL DU MATCH</small>
                <span class="score-number" id="totalScore">0</span>
            </div>

            <button class="btn-save" onclick="saveMatch()">ENREGISTRER LE MATCH</button>
        </div>
    </div>

    <!-- VUE RÉSULTATS -->
    <div id="resultsView" class="view">
        <div class="card">
            <div class="header-actions">
                <h2>Synthèse des Équipes</h2>
                <span style="font-size: 0.8rem; color: var(--secondary);">Trié par numéro d'équipe</span>
            </div>
            <div id="resultsContainer"></div>
            <div style="margin-top: 30px; display: flex; justify-content: space-between; gap: 10px;">
                <button onclick="exportData()" style="flex: 1; background:#e2e8f0; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:600;">Télécharger JSON</button>
                <button onclick="clearHistory()" style="flex: 1; background:#fee2e2; color:#b91c1c; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:600;">Effacer tout</button>
            </div>
        </div>
    </div>
</div>

<script>
    let matchState = {
        moteur1: 0, moteur2: 0, moteur3: 0, moteur4: 0, moteur5: 0, moteur6: 0,
        station1: 0, station2: 0, station3: 0,
        supp: 0
    };

    const LIMITS = { moteur: 3, station: 3, global: 21 };
    let tournamentHistory = JSON.parse(localStorage.getItem('robotics_history')) || {};

    function getMoteurPoints(count) {
        if (count === 1) return 50;
        if (count === 2) return 100;
        if (count === 3) return 250;
        return 0;
    }

    function switchTab(view) {
        document.querySelectorAll('.view, .tab').forEach(el => el.classList.remove('active'));
        if(view === 'scout') {
            document.getElementById('scoutView').classList.add('active');
            document.querySelectorAll('.tab')[0].classList.add('active');
        } else {
            document.getElementById('resultsView').classList.add('active');
            document.querySelectorAll('.tab')[1].classList.add('active');
            renderHistory();
        }
    }

    function getTotalPiecesUsed() {
        let total = 0;
        for(let i=1; i<=6; i++) total += matchState['moteur' + i];
        total += matchState.supp;
        return total;
    }

    function updateVal(key, delta) {
        let currentTotalPieces = getTotalPiecesUsed();
        let isLimitedSection = key.startsWith('moteur') || key === 'supp';
        
        if (delta > 0 && isLimitedSection && currentTotalPieces >= LIMITS.global) return;

        let maxIndividualLimit = 99;
        if(key.startsWith('moteur')) maxIndividualLimit = LIMITS.moteur;
        if(key.startsWith('station')) maxIndividualLimit = LIMITS.station;

        let newVal = matchState[key] + delta;
        if(newVal >= 0 && newVal <= maxIndividualLimit) {
            matchState[key] = newVal;
            document.getElementById(key + '-val').innerText = matchState[key];
            calculateScore();
            updateButtonStates();
        }
    }

    function updateButtonStates() {
        const currentTotal = getTotalPiecesUsed();
        const limitReached = currentTotal >= LIMITS.global;
        
        const counterEl = document.getElementById('global-piece-count');
        if (counterEl) counterEl.innerText = `${currentTotal} / ${LIMITS.global}`;

        // Moteurs
        for(let i=1; i<=6; i++) {
            const key = 'moteur' + i;
            const val = matchState[key];
            document.getElementById(key + '-minus').disabled = (val <= 0);
            document.getElementById(key + '-plus').disabled = (val >= LIMITS.moteur || limitReached);
        }

        // Stations
        for(let i=1; i<=3; i++) {
            const key = 'station' + i;
            const val = matchState[key];
            document.getElementById(key + '-minus').disabled = (val <= 0);
            document.getElementById(key + '-plus').disabled = (val >= LIMITS.station);
        }

        // Pièces Supplémentaires
        document.getElementById('supp-minus').disabled = (matchState.supp <= 0);
        document.getElementById('supp-plus').disabled = limitReached;
    }

    function calculateDetailedScore() {
        let scoreMoteurs = 0;
        for(let i=1; i<=6; i++) scoreMoteurs += getMoteurPoints(matchState['moteur' + i]);
        let scoreStations = (matchState.station1 + matchState.station2 + matchState.station3) * 30;
        let baseSuppScore = matchState.supp * 40;
        let bonusHauteurVal = document.getElementById('bonusHauteur').checked ? Math.round(baseSuppScore * 0.6) : 0;
        let bonusNombreVal = document.getElementById('bonusNombre').checked ? Math.round(baseSuppScore * 0.4) : 0;

        return {
            total: scoreMoteurs + scoreStations + baseSuppScore + bonusHauteurVal + bonusNombreVal,
            moteurs: scoreMoteurs,
            stations: scoreStations,
            pieces: baseSuppScore,
            bonusHauteur: bonusHauteurVal,
            bonusNombre: bonusNombreVal
        };
    }

    function calculateScore() {
        const detail = calculateDetailedScore();
        document.getElementById('subtotal-moteurs').innerText = detail.moteurs + ' pts';
        document.getElementById('subtotal-stations').innerText = detail.stations + ' pts';
        document.getElementById('subtotal-supp').innerText = detail.pieces + ' pts';
        document.getElementById('subtotal-bonus-global').innerText = '+' + (detail.bonusHauteur + detail.bonusNombre) + ' pt';
        document.getElementById('val-bonus-hauteur').innerText = '+' + detail.bonusHauteur + ' pt';
        document.getElementById('val-bonus-nombre').innerText = '+' + detail.bonusNombre + ' pt';
        document.getElementById('bonusSummary').innerText = `Pièces Supp: ${matchState.supp} | Bonus: +${detail.bonusHauteur + detail.bonusNombre}`;
        document.getElementById('totalScore').innerText = detail.total;
        return detail.total;
    }

    function saveMatch() {
        const team = document.getElementById('teamNumber').value;
        if(!team) { alert("Numéros d'équipe et match requis !"); return; }
        const scoreDetails = calculateDetailedScore();
        if(!tournamentHistory[team]) tournamentHistory[team] = [];
        tournamentHistory[team].push({
            score: scoreDetails.total,
            breakdown: scoreDetails,
            date: new Date().toLocaleString('fr-FR', { hour: '2-digit', minute: '2-digit' })
        });
        localStorage.setItem('robotics_history', JSON.stringify(tournamentHistory));
        alert("Match enregistré !");
        resetForm();
    }

    function resetForm() {
        Object.keys(matchState).forEach(key => {
            matchState[key] = 0;
            if(document.getElementById(key + '-val')) document.getElementById(key + '-val').innerText = 0;
        });
        document.getElementById('bonusHauteur').checked = false;
        document.getElementById('bonusNombre').checked = false;
        document.getElementById('teamNumber').value = '';
        calculateScore();
        updateButtonStates();
    }

    function resetFormWithConfirm() {
        if (confirm("Nouveau match ? (Remise à zéro)")) resetForm();
    }

    function toggleDetails(team) {
        document.getElementById(`details-${team}`).classList.toggle('open');
    }

    function renderHistory() {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = '';
        const teamStats = Object.keys(tournamentHistory).map(teamId => {
            const matches = tournamentHistory[teamId];
            const totals = matches.reduce((acc, m) => { acc.score += m.score; return acc; }, { score:0 });
            return { id: teamId, matches: matches, totalScore: totals.score, avg: totals.score / matches.length };
        });
        teamStats.sort((a, b) => parseInt(a.id) - parseInt(b.id));
        if (teamStats.length === 0) {
            container.innerHTML = '<div class="empty-state">Aucun match enregistré.</div>';
            return;
        }
        teamStats.forEach((stat) => {
            let matchCards = stat.matches.map(m => {
                const b = m.breakdown || { moteurs: 0, stations: 0, pieces: 0, bonusHauteur: 0, bonusNombre: 0 };
                return `
                <div class="match-card">
                    <div class="match-header">
                        <span style="font-weight:bold;">Match #${m.matchNum}</span>
                        <span style="font-size:0.75rem; color:var(--secondary);">${m.date}</span>
                    </div>
                    <table class="breakdown-table">
                        <tr><td>Moteurs</td><td>${b.moteurs} pts</td></tr>
                        <tr><td>Stations de réparation</td><td>${b.stations} pts</td></tr>
                        <tr><td>Pièces supplémentaires</td><td>${b.pieces} pts</td></tr>
                        <tr><td>Bonus Hauteur/Nombre</td><td>+${b.bonusHauteur + b.bonusNombre} pts</td></tr>
                        <tr style="border-top: 1px solid #f1f5f9; font-weight: bold; color:var(--primary);">
                            <td style="padding-top:5px;">SCORE MATCH</td>
                            <td style="padding-top:5px;">${m.score} pts</td>
                        </tr>
                    </table>
                </div>`;
            }).join('');
            container.innerHTML += `
                <div class="team-group">
                    <div class="team-header" onclick="toggleDetails('${stat.id}')">
                        <div class="team-id-container">
                            <span class="team-id"># ${stat.id}</span>
                        </div>
                        <div class="team-summary">
                            <span class="score-total-val">${stat.totalScore} pts</span>
                            <span class="score-avg-val">Moy: ${stat.avg.toFixed(1)} / match</span>
                        </div>
                    </div>
                    <div class="team-details" id="details-${stat.id}">${matchCards}</div>
                </div>`;
        });
    }

function clearHistory() { 
    const codeInput = prompt("Pour supprimer TOUT l'historique, veuillez saisir le code de sécurité :");
    
    if (codeInput === "5440") {
        if (confirm("Êtes-vous absolument certain de vouloir tout supprimer ? Cette action est irréversible.")) { 
            localStorage.removeItem('robotics_history'); 
            tournamentHistory = {}; 
            renderHistory(); 
            alert("Historique supprimé avec succès.");
        } 
    } else if (codeInput !== null) {
        alert("Code incorrect. L'opération a été annulée.");
    }
}
    
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tournamentHistory));
        const dl = document.createElement('a');
        dl.href = dataStr; dl.download = `tournoi_${new Date().toLocaleDateString()}.json`; dl.click();
    }

    window.onload = () => {
        updateButtonStates();
        calculateScore();
    };
</script>

</body>
</html>
